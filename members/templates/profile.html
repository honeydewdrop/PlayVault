{% include "navbar.html" %}

{% block content %}
    <h1>Welcome, {{ user.username }}!</h1>

    {% if profile.header_image %}
        <img id="header-image" src="{{ profile.header_image.url }}" alt="Header Image" style="width: 100%; height: auto;">
    {% else %}
        <p>No header image uploaded yet.</p>
    {% endif %}

    {% if profile.profile_picture %}
        <img id="profile-picture" src="{{ profile.profile_picture.url }}" alt="Profile Picture" style="width: 150px; height: 150px;">
    {% else %}
        <p>No profile picture uploaded yet.</p>
    {% endif %}

    <h2>Your Biography</h2>
    <p id="biography-text">{{ profile.biography }}</p>

    <form id="profile-picture-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <h2>Update Profile Picture</h2>
        {{ profile_picture_form.as_p }}
        <button type="submit" name="profile_picture">Update Profile Picture</button>
    </form>
    
    <form id="header-image-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <h2>Update Header Image</h2>
        {{ header_image_form.as_p }}
        <button type="submit" name="header_image">Update Header Image</button>
    </form>
    
    <form id="biography_form" method="post">
        {% csrf_token %}
        <h2>Update Biography</h2>
        {{ biography_form.as_p }}
        <button type="submit" name="biography">Update Biography</button>
    </form>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <h2>Your Reviews</h2>
    {% if user_reviews %}
        <ul id="reviews-list">
            {% for review in user_reviews %}
                <li class="review-item" {% if forloop.counter > 3 %}style="display: none;"{% endif %}>
                    <strong>{{ review.game.name }}</strong> - Rating: {{ review.rating }}<br>
                    <p>{{ review.reviewtext }}</p>
                </li>
            {% endfor %}
        </ul>
        {% if user_reviews|length > 3 %}
            <button id="toggle-reviews" class="btn">Show More</button>
        {% endif %}
    {% else %}
        <p>You have not written any reviews yet.</p>
    {% endif %}    

    <h2> My Games </h2>
    {% if user_games %}
        <div style="display: flex; justify-content: space-between;">
            <div style="flex: 1; margin-right: 20px;">
                <h3>Planning</h3>
                <ul>
                    {% for game_status in user_games %}
                        {% if game_status.status == 'planning' %}
                            <li>
                                <a href="{% url 'game_detail' game_status.game.id %}">{{ game_status.game.name }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
    
            <div style="flex: 1; margin-right: 20px;">
                <h3>In Progress</h3>
                <ul>
                    {% for game_status in user_games %}
                        {% if game_status.status == 'in_progress' %}
                            <li>
                                <a href="{% url 'game_detail' game_status.game.id %}">{{ game_status.game.name }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
    
            <div style="flex: 1; margin-right: 20px;">
                <h3>Dropped</h3>
                <ul>
                    {% for game_status in user_games %}
                        {% if game_status.status == 'dropped' %}
                            <li>
                                <a href="{% url 'game_detail' game_status.game.id %}">{{ game_status.game.name }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
    
            <div style="flex: 1;">
                <h3>Completed</h3>
                <ul>
                    {% for game_status in user_games %}
                        {% if game_status.status == 'completed' %}
                            <li>
                                <a href="{% url 'game_detail' game_status.game.id %}">{{ game_status.game.name }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% else %}
        <p>You have no saved games.</p>
    {% endif %}

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
$(document).ready(function() {
    $(document).ready(function() {
    let showMore = true; // Tracks whether we're showing more or fewer reviews

    $('#toggle-reviews').on('click', function() {
        if (showMore) {
            $('.review-item').show(); // Show all reviews
            $(this).text('Show Less'); // Update button text
        } else {
            $('.review-item').slice(3).hide(); // Hide reviews after the third
            $(this).text('Show More'); // Update button text
        }
        showMore = !showMore; // Toggle state
    });
});
    // AJAX for Profile Picture
    $('#profile-picture-form').on('submit', function(e) {
        e.preventDefault(); // Prevent the default form submission
        var formData = new FormData(this); // Create FormData object

        $.ajax({
            type: 'POST',
            url: '{% url "profile_view" %}', // Update with your URL
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                console.log(response);  // Log the entire response
            if (response.success) {
                $('#profile-picture').attr('src', response.profile_picture_url); // Update the image
            } else {
                alert('Failed to update profile picture: ' + JSON.stringify(response.errors || 'Unknown error'));
        }
}
        });
    });

    // AJAX for Header Image
    $('#header-image-form').on('submit', function(e) {
        e.preventDefault(); // Prevent the default form submission
        var formData = new FormData(this); // Create FormData object

        $.ajax({
            type: 'POST',
            url: '{% url "profile_view" %}', // Update with your URL
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    $('#header-image').attr('src', response.header_image_url); // Update the image
                } else {
                    alert('Failed to update header image.');
                }
            }
        });
    });

    // AJAX for Biography
    $('#biography-form').on('submit', function(e) {
        e.preventDefault(); // Prevent the default form submission
        var formData = $(this).serialize(); // Serialize the form data

        $.ajax({
            type: 'POST',
            url: '{% url "profile_view" %}', // Update with your URL
            data: formData,
            success: function(response) {
                if (response.success) {
                    $('#biography-text').text(response.biography); // Update the biography text
                } else {
                    alert('Failed to update biography.');
                }
            }
        });
    });
});
</script>
{% endblock %}